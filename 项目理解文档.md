# 项目理解：Obsidian 示例插件与 Obsidian API

## 概述

本文档展示了对 Obsidian 示例插件项目和 Obsidian API (https://github.com/obsidianmd/obsidian-api) 的全面理解。

## 关于本项目

### 目的
这是一个用于开发 Obsidian 插件的示例/模板项目。它作为插件开发者的起点，展示了 Obsidian 插件 API 的基本功能。

### 技术栈
- **语言**: TypeScript（编译为 JavaScript）
- **构建工具**: esbuild（快速 JavaScript 打包工具）
- **包管理器**: npm
- **运行环境**: 在 Obsidian 应用内运行（基于 Electron）
- **API**: Obsidian 插件 API（TypeScript 类型定义）

### 项目结构
```
.
├── main.ts              # 主插件入口点（源代码）
├── main.js              # 编译输出（生成文件，不在 git 中）
├── manifest.json        # 插件元数据
├── package.json         # npm 依赖和脚本
├── tsconfig.json        # TypeScript 配置
├── esbuild.config.mjs   # 构建配置
├── styles.css           # 可选的插件样式
└── README.md            # 文档
```

## 理解 Obsidian API

### 什么是 Obsidian API？

Obsidian API 是一个 TypeScript/JavaScript 接口，允许开发者通过插件扩展 Obsidian 的功能。该 API 通过 npm 包 `obsidian` 以 TypeScript 类型定义（`obsidian.d.ts`）的形式分发。

**仓库地址**: https://github.com/obsidianmd/obsidian-api

### Obsidian API 的关键组件

#### 1. 插件基类
每个插件都扩展 `Plugin` 类并实现生命周期方法：
- `onload()`：插件启用时调用
- `onunload()`：插件禁用时调用

#### 2. App 对象
Obsidian 功能的中心接口，通过 `this.app` 访问：
- **Vault**：文件系统访问（读取/写入/删除文件）
- **Workspace**：UI 管理（视图、面板、叶子节点）
- **MetadataCache**：快速访问文件元数据、链接、标签
- **FileManager**：高级文件操作

#### 3. 插件功能

##### 命令
向命令面板添加新命令：
```typescript
this.addCommand({
  id: 'my-command',
  name: '我的命令',
  callback: () => { /* 操作 */ }
});
```

##### 功能区图标
向左侧边栏添加可点击的图标：
```typescript
this.addRibbonIcon('dice', '工具提示', (evt) => {
  // 处理点击
});
```

##### 设置
提供配置界面：
```typescript
this.addSettingTab(new MySettingTab(this.app, this));
```

##### 事件
监听应用事件：
```typescript
this.registerEvent(
  this.app.workspace.on('file-open', (file) => {
    // 处理文件打开
  })
);
```

##### DOM 事件
监听 DOM 事件并自动清理：
```typescript
this.registerDomEvent(document, 'click', (evt) => {
  // 处理点击
});
```

##### 定时器
注册自动清理的定时器：
```typescript
this.registerInterval(
  window.setInterval(() => { /* 周期性任务 */ }, 5000)
);
```

##### 模态框
创建自定义对话框：
```typescript
class MyModal extends Modal {
  onOpen() {
    // 填充模态框内容
  }
  onClose() {
    // 清理
  }
}
```

##### 视图
创建自定义面板/标签页：
```typescript
class MyView extends ItemView {
  getViewType(): string { return 'my-view'; }
  getDisplayText(): string { return '我的视图'; }
  async onOpen() { /* 渲染 */ }
}
```

## 本示例插件演示的功能

### 1. 功能区图标
在左侧边栏创建一个骰子图标，点击时显示通知。

**代码位置**: `main.ts` 第 20-25 行
```typescript
const ribbonIconEl = this.addRibbonIcon('dice', 'Sample Plugin', (_evt: MouseEvent) => {
  new Notice('This is a notice!');
});
```

### 2. 状态栏
在应用底部的状态栏添加文本。

**代码位置**: `main.ts` 第 28-29 行
```typescript
const statusBarItemEl = this.addStatusBarItem();
statusBarItemEl.setText('Status Bar Text');
```

### 3. 命令
展示三种类型的命令：

#### 简单命令
触发时打开模态框。

**代码位置**: `main.ts` 第 32-38 行

#### 编辑器命令
操作当前编辑器，替换选中的文本。

**代码位置**: `main.ts` 第 40-47 行

#### 条件命令
仅在满足特定条件时可用（例如，当前视图是 Markdown 视图）。

**代码位置**: `main.ts` 第 49-66 行

### 4. 模态对话框
打开时显示"Woah!"的简单模态框。

**代码位置**: `main.ts` 第 94-108 行

### 5. 设置标签页
演示带持久化的插件设置。

**代码位置**: `main.ts` 第 110-134 行
- 显示用于"秘密"设置的文本输入
- 使用 `loadData()`/`saveData()` 持久化设置
- 更改时自动保存

### 6. 事件监听器
#### DOM 事件
记录文档上的所有点击。

**代码位置**: `main.ts` 第 73-75 行

#### 定时器
每 5 分钟记录一条消息。

**代码位置**: `main.ts` 第 78 行

### 7. 设置持久化
展示如何：
- 定义设置接口
- 设置默认值
- 插件启动时加载设置
- 更改时保存设置

**代码位置**: `main.ts` 第 5-11、85-91 行

## 构建过程

### 开发构建（监视模式）
```bash
npm run dev
```
- 监视文件更改
- 自动重新构建
- 包含源映射用于调试
- 不压缩

### 生产构建
```bash
npm run build
```
- 使用 TypeScript 进行类型检查
- 使用 esbuild 打包
- 压缩输出
- 不包含源映射
- 输出：`main.js`（本示例约 2.2KB）

### 构建配置
**文件**: `esbuild.config.mjs`
- 入口点：`main.ts`
- 输出：`main.js`
- 格式：CommonJS (CJS)
- 目标：ES2018
- 外部依赖：obsidian、electron、codemirror（由 Obsidian 提供）
- 打包所有其他依赖项

## 插件安装和使用

### 手动安装
1. 复制到保管库：`<保管库文件夹>/.obsidian/plugins/sample-plugin/`
2. 需要的文件：
   - `main.js`（编译输出）
   - `manifest.json`（元数据）
   - `styles.css`（如果使用）
3. 重新加载 Obsidian
4. 在**设置 → 社区插件**中启用

### 开发工作流
1. 将仓库克隆到 `.obsidian/plugins/your-plugin-name/`
2. 运行 `npm install`
3. 运行 `npm run dev`（监视模式）
4. 修改 `main.ts`
5. 重新加载 Obsidian 以测试更改

## Manifest 结构

**文件**: `manifest.json`

必需字段：
- `id`：唯一插件标识符（必须与文件夹名称匹配）
- `name`：显示名称
- `version`：语义化版本（x.y.z）
- `minAppVersion`：所需的最低 Obsidian 版本
- `description`：简要描述
- `author`：作者姓名
- `authorUrl`：作者网站
- `isDesktopOnly`：插件是否在移动设备上工作

## TypeScript 配置

**文件**: `tsconfig.json`

关键设置：
- `target: "ES6"`：JavaScript 版本
- `module: "ESNext"`：模块系统
- `strictNullChecks: true`：类型安全
- `noImplicitAny: true`：要求类型注解
- 包含用于调试的源映射

## 关键概念

### 插件生命周期
1. **加载**：启用插件时调用 `onload()`
   - 注册命令、UI 元素、事件
   - 加载设置
   - 初始化状态

2. **活动**：插件正在运行
   - 命令可用
   - 事件监听器活动
   - UI 元素可见

3. **卸载**：禁用插件时调用 `onunload()`
   - 清理资源
   - 移除 UI 元素
   - 注销事件（使用 `register*` 方法时自动）

### 资源管理
API 提供自动清理方法：
- `this.registerEvent()`：自动注销事件监听器
- `this.registerDomEvent()`：自动移除 DOM 监听器
- `this.registerInterval()`：自动清除定时器
- `this.addRibbonIcon()`：自动移除功能区图标
- `this.addStatusBarItem()`：自动移除状态栏项

这确保插件在禁用时正确清理。

### 数据持久化
插件可以持久化数据：
```typescript
// 加载（返回任何可 JSON 序列化的数据）
const data = await this.loadData();

// 保存（接受任何可 JSON 序列化的数据）
await this.saveData(myData);
```

数据存储在 `<保管库文件夹>/.obsidian/plugins/<plugin-id>/data.json`

## 最佳实践（来自 AGENTS.md）

### 代码组织
- 保持 `main.ts` 最小化（仅生命周期）
- 将功能拆分为单独的模块
- 使用清晰的模块边界
- 避免大文件（>200-300 行）

### 性能
- 保持 `onload()` 轻量
- 推迟繁重的工作直到需要时
- 批量磁盘访问
- 对昂贵的操作进行防抖

### 安全与隐私
- 默认本地/离线操作
- 无隐藏遥测
- 网络请求需要明确的选择加入
- 永远不要执行远程代码
- 尊重用户隐私

### 移动兼容性
- 如果 `isDesktopOnly: false`，在 iOS 和 Android 上测试
- 避免 Node.js/Electron API 以支持移动
- 注意内存限制

### 版本管理
- 使用语义化版本
- 更新 `manifest.json` 版本
- 更新 `versions.json`（映射插件版本 → 最低 Obsidian 版本）
- 使用精确的版本标签创建 GitHub 发布
- 将 `main.js`、`manifest.json`、`styles.css` 附加到发布

## 相关资源

- **Obsidian API 仓库**: https://github.com/obsidianmd/obsidian-api
- **API 文档**: https://docs.obsidian.md
- **示例插件**: https://github.com/obsidianmd/obsidian-sample-plugin
- **插件指南**: https://docs.obsidian.md/Plugins/Releasing/Plugin+guidelines
- **开发者政策**: https://docs.obsidian.md/Developer+policies
- **样式指南**: https://help.obsidian.md/style-guide

## 结论

此示例插件有效展示了 Obsidian 插件 API 的核心功能：
1. **UI 扩展**：功能区图标、状态栏、模态框
2. **命令**：具有不同触发器的各种类型
3. **设置**：带 UI 的持久配置
4. **事件**：DOM 和应用事件处理
5. **生命周期**：正确的资源管理

该插件是希望扩展 Obsidian 功能同时遵循插件开发最佳实践的开发者的绝佳起点。
